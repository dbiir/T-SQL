CREATE TABLE my_tt_agg_small (
    symbol character(16),
    event_ts bigint,
    trade_price numeric,
    trade_volume bigint
) DISTRIBUTED BY (symbol);
CREATE TABLE my_tq_agg_small (
    ets bigint,
    sym character varying(16),
    bid_price numeric,
    ask_price numeric,
    end_ts bigint
) DISTRIBUTED BY (ets);
COPY my_tt_agg_small (symbol, event_ts, trade_price, trade_volume) FROM stdin;
COPY my_tq_agg_small (ets, sym, bid_price, ask_price, end_ts) FROM stdin;
CREATE INDEX my_tq_agg_small_ets_end_ts_ix ON my_tq_agg_small USING btree (ets, end_ts);
analyze my_tq_agg_small;
analyze my_tt_agg_small;
set optimizer_enable_indexjoin=on;
set optimizer_nestloop_factor = 1.0;
-- force_explain
EXPLAIN 
SELECT (tt.event_ts / 100000) / 5 * 5 as fivemin, COUNT(*)
FROM my_tt_agg_small tt, my_tq_agg_small tq
WHERE tq.sym = tt.symbol AND
      tt.event_ts >= tq.ets AND
      tt.event_ts <  tq.end_ts
GROUP BY 1
ORDER BY 1 asc ;
                                                                              QUERY PLAN                                                                              
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Gather Motion 3:1  (slice3; segments: 3)  (cost=0.00..878.47 rows=413 width=16)
   Merge Key: ((((my_tt_agg_small.event_ts / 100000) / 5) * 5))
   ->  GroupAggregate  (cost=0.00..878.44 rows=138 width=16)
         Group Key: ((((my_tt_agg_small.event_ts / 100000) / 5) * 5))
         ->  Sort  (cost=0.00..878.44 rows=138 width=16)
               Sort Key: ((((my_tt_agg_small.event_ts / 100000) / 5) * 5))
               ->  Redistribute Motion 3:3  (slice2; segments: 3)  (cost=0.00..878.35 rows=138 width=16)
                     Hash Key: ((((my_tt_agg_small.event_ts / 100000) / 5) * 5))
                     ->  Result  (cost=0.00..878.34 rows=138 width=16)
                           ->  HashAggregate  (cost=0.00..878.34 rows=138 width=16)
                                 Group Key: (((my_tt_agg_small.event_ts / 100000) / 5) * 5)
                                 ->  Result  (cost=0.00..866.40 rows=94594 width=8)
                                       ->  Hash Join  (cost=0.00..865.64 rows=94594 width=8)
                                             Hash Cond: ((my_tq_agg_small.sym)::text = (my_tt_agg_small.symbol)::text)
                                             Join Filter: ((my_tt_agg_small.event_ts >= my_tq_agg_small.ets) AND (my_tt_agg_small.event_ts < my_tq_agg_small.end_ts))
                                             ->  Seq Scan on my_tq_agg_small  (cost=0.00..431.02 rows=676 width=20)
                                             ->  Hash  (cost=431.30..431.30 rows=420 width=25)
                                                   ->  Broadcast Motion 3:3  (slice1; segments: 3)  (cost=0.00..431.30 rows=420 width=25)
                                                         ->  Seq Scan on my_tt_agg_small  (cost=0.00..431.01 rows=140 width=25)
 Optimizer: Pivotal Optimizer (GPORCA) version 3.64.0
(20 rows)

  
SELECT (tt.event_ts / 100000) / 5 * 5 as fivemin, COUNT(*)
FROM my_tt_agg_small tt, my_tq_agg_small tq
WHERE tq.sym = tt.symbol AND
      tt.event_ts >= tq.ets AND
      tt.event_ts <  tq.end_ts
GROUP BY 1
ORDER BY 1 asc ;
   fivemin    | count 
--------------+-------
 201011261015 |     2
 201011261045 |     1
 201011261110 |     1
 201011261125 |     1
 201011261240 |     1
 201011261245 |     1
 201011261315 |     2
 201011261320 |     3
(8 rows)

set optimizer_enable_hashjoin = off;
set enable_hashjoin=off;
set enable_seqscan=off;
set enable_mergejoin=off;
set enable_nestloop=on;
set enable_indexscan=on;
-- start_ignore
-- Known_opt_diff: OPT-929
-- end_ignore
-- force_explain
set optimizer_segments = 2;
set optimizer_nestloop_factor = 1.0;
EXPLAIN 
SELECT (tt.event_ts / 100000) / 5 * 5 as fivemin, COUNT(*)
FROM my_tt_agg_small tt, my_tq_agg_small tq
WHERE tq.sym = tt.symbol AND
      tt.event_ts >= tq.ets AND
      tt.event_ts <  tq.end_ts
GROUP BY 1
ORDER BY 1 asc ;
                                                                                                            QUERY PLAN                                                                                                             
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Gather Motion 3:1  (slice3; segments: 3)  (cost=0.00..1359.12 rows=413 width=16)
   Merge Key: ((((my_tt_agg_small.event_ts / 100000) / 5) * 5))
   ->  GroupAggregate  (cost=0.00..1359.09 rows=138 width=16)
         Group Key: ((((my_tt_agg_small.event_ts / 100000) / 5) * 5))
         ->  Sort  (cost=0.00..1359.08 rows=138 width=16)
               Sort Key: ((((my_tt_agg_small.event_ts / 100000) / 5) * 5))
               ->  Redistribute Motion 3:3  (slice2; segments: 3)  (cost=0.00..1358.94 rows=138 width=16)
                     Hash Key: ((((my_tt_agg_small.event_ts / 100000) / 5) * 5))
                     ->  Result  (cost=0.00..1358.93 rows=138 width=16)
                           ->  HashAggregate  (cost=0.00..1358.93 rows=138 width=16)
                                 Group Key: (((my_tt_agg_small.event_ts / 100000) / 5) * 5)
                                 ->  Result  (cost=0.00..1341.01 rows=94594 width=8)
                                       ->  Nested Loop  (cost=0.00..1339.87 rows=94594 width=8)
                                             Join Filter: (((my_tq_agg_small.sym)::bpchar = my_tt_agg_small.symbol) AND (my_tt_agg_small.event_ts >= my_tq_agg_small.ets) AND (my_tt_agg_small.event_ts < my_tq_agg_small.end_ts))
                                             ->  Seq Scan on my_tt_agg_small  (cost=0.00..431.01 rows=140 width=25)
                                             ->  Materialize  (cost=0.00..431.16 rows=676 width=20)
                                                   ->  Redistribute Motion 3:3  (slice1; segments: 3)  (cost=0.00..431.14 rows=676 width=20)
                                                         Hash Key: (my_tq_agg_small.sym)::bpchar
                                                         ->  Seq Scan on my_tq_agg_small  (cost=0.00..431.03 rows=676 width=20)
 Optimizer: Pivotal Optimizer (GPORCA) version 3.1.0
(20 rows)

reset optimizer_segments;
reset optimizer_nestloop_factor;
SELECT (tt.event_ts / 100000) / 5 * 5 as fivemin, COUNT(*)
FROM my_tt_agg_small tt, my_tq_agg_small tq
WHERE tq.sym = tt.symbol AND
      tt.event_ts >= tq.ets AND
      tt.event_ts <  tq.end_ts
GROUP BY 1
ORDER BY 1 asc ;
   fivemin    | count 
--------------+-------
 201011261015 |     2
 201011261045 |     1
 201011261110 |     1
 201011261125 |     1
 201011261240 |     1
 201011261245 |     1
 201011261315 |     2
 201011261320 |     3
(8 rows)

set optimizer_enable_hashjoin = on;
