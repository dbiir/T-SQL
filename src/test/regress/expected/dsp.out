-- Test suite for appendonly default storage parameters.
--
-- Scope: database, role and session level defaults.
drop database if exists dsp1;
NOTICE:  database "dsp1" does not exist, skipping
create database dsp1;
alter database dsp1 set gp_default_storage_options =
	"appendonly=true,orientation=column";
drop database if exists dsp2;
NOTICE:  database "dsp2" does not exist, skipping
create database dsp2;
alter database dsp2 set gp_default_storage_options =
	"appendonly=true,checksum=true";
-- Testing pg_authid.rolconfig is currently deferred in
-- installcheck-good because it becomes contrived.  These tests will
-- be covered in detail in Divya's test plan for default storage
-- options.
--
-- drop role if exists dsprole1;
-- create role dsprole1 with login;
-- drop role if exists dsprole2;
-- create role dsprole2 with login;
-- -- Allow all users to login from local host.
-- \! cp $(psql -d postgres -t -c "show data_directory")/pg_hba.conf /tmp/
-- \! echo "local    all    all    trust" >> /tmp/pg_hba.conf
-- \! cp /tmp/pg_hba.conf $(psql -d postgres -t -c "show data_directory")/pg_hba.conf
-- \! gpstop -qau
-- alter role dsprole1 set gp_default_storage_options to
-- 	"appendonly=true,blocksize=8192";
-- alter role dsprole2 set gp_default_storage_options to
-- 	"appendonly=true,compresslevel=2";
--
-- \c dsp1 dsprole2
--
-- Leaving roles around affects others, e.g. auth_constraints.sql.
-- Therefore drop them in the end.
\c dsp1
show gp_default_storage_options;
                             gp_default_storage_options                             
------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=none,checksum=true,orientation=column
(1 row)

create table t1 (a int, b int) distributed by (a);
\d+ t1
                                         Append-Only Columnar Table "public.t1"
 Column |  Type   | Modifiers | Storage | Stats target | Compression Type | Compression Level | Block Size | Description 
--------+---------+-----------+---------+--------------+------------------+-------------------+------------+-------------
 a      | integer |           | plain   |              | none             | 0                 | 32768      | 
 b      | integer |           | plain   |              | none             | 0                 | 32768      | 
Checksum: t
Distributed by: (a)
Options: appendonly=true, orientation=column

insert into t1 select i, i from generate_series(1,5)i;
update t1 set b = 50 where a < 50;
set gp_default_storage_options=
	"appendonly=true,orientation=column,blocksize=8192";
show gp_default_storage_options;
                            gp_default_storage_options                             
-----------------------------------------------------------------------------------
 appendonly=true,blocksize=8192,compresstype=none,checksum=true,orientation=column
(1 row)

create table t2 (a int, b varchar, c text) distributed by (a);
\d+ t2
                                               Append-Only Columnar Table "public.t2"
 Column |       Type        | Modifiers | Storage  | Stats target | Compression Type | Compression Level | Block Size | Description 
--------+-------------------+-----------+----------+--------------+------------------+-------------------+------------+-------------
 a      | integer           |           | plain    |              | none             | 0                 | 8192       | 
 b      | character varying |           | extended |              | none             | 0                 | 8192       | 
 c      | text              |           | extended |              | none             | 0                 | 8192       | 
Checksum: t
Distributed by: (a)
Options: appendonly=true, blocksize=8192, orientation=column

create table t3 (a int, b float) with (appendonly=false)
	distributed by (a);
\d+ t3
                              Table "public.t3"
 Column |       Type       | Modifiers | Storage | Stats target | Description 
--------+------------------+-----------+---------+--------------+-------------
 a      | integer          |           | plain   |              | 
 b      | double precision |           | plain   |              | 
Distributed by: (a)
Options: appendonly=false

create table t4 (a int, b float, c text) with
	(appendonly=true,orientation=row) distributed by (a);
-- Set defaults to heap, verify basic operations.
set gp_default_storage_options="appendonly=false";
show gp_default_storage_options;
                            gp_default_storage_options                            
----------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=none,checksum=true,orientation=row
(1 row)

create table h1 (a int, b int) distributed by (a);
create index ih1 on h1(a);
insert into h1 select i, i*2 from generate_series(1,50)i;
set enable_seqscan=off;
show enable_seqscan;
 enable_seqscan 
----------------
 off
(1 row)

select * from h1 where a > 5 and a < 10 order by a,b;
 a | b  
---+----
 6 | 12
 7 | 14
 8 | 16
 9 | 18
(4 rows)

select relname,relstorage,relkind,reloptions from pg_class
	where relkind='r' and relnamespace=2200 order by relname;
 relname | relstorage | relkind |                     reloptions                      
---------+------------+---------+-----------------------------------------------------
 h1      | h          | r       | 
 t1      | c          | r       | {appendonly=true,orientation=column}
 t2      | c          | r       | {appendonly=true,blocksize=8192,orientation=column}
 t3      | h          | r       | {appendonly=false}
 t4      | a          | r       | {appendonly=true,orientation=row,blocksize=8192}
(5 rows)

select relid::regclass, blocksize, compresstype,
	compresslevel, columnstore, checksum from pg_appendonly order by 1;
 relid | blocksize | compresstype | compresslevel | columnstore | checksum 
-------+-----------+--------------+---------------+-------------+----------
 t1    |     32768 |              |             0 | t           | t
 t2    |      8192 |              |             0 | t           | t
 t4    |      8192 |              |             0 | f           | t
(3 rows)

\c dsp2
set gp_default_storage_options=
	"appendonly=true,compresslevel=2,checksum=true";
show gp_default_storage_options;
                                   gp_default_storage_options                                    
-------------------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=zlib,compresslevel=2,checksum=true,orientation=row
(1 row)

create table t1 (a int, b int) distributed by (a);
\d+ t1
                    Append-Only Table "public.t1"
 Column |  Type   | Modifiers | Storage | Stats target | Description 
--------+---------+-----------+---------+--------------+-------------
 a      | integer |           | plain   |              | 
 b      | integer |           | plain   |              | 
Compression Type: zlib
Compression Level: 2
Block Size: 32768
Checksum: t
Distributed by: (a)
Options: appendonly=true, compresslevel=2

-- should fail because current default orientation is row
create table t2 (
	a int encoding(blocksize=65536),
	b float encoding(compresstype=zlib),
	c int encoding(compresstype=rle_type, compresslevel=2),
	d text
) distributed by (a);
ERROR:  ENCODING clause only supported with column oriented tables
-- should succeed
create table t2 (
	a int encoding(blocksize=65536),
	b float encoding(compresstype=zlib),
	c int encoding(compresstype=rle_type, compresslevel=2),
	d text
) with (orientation=column) distributed by (a);
\d+ t2
                                              Append-Only Columnar Table "public.t2"
 Column |       Type       | Modifiers | Storage  | Stats target | Compression Type | Compression Level | Block Size | Description 
--------+------------------+-----------+----------+--------------+------------------+-------------------+------------+-------------
 a      | integer          |           | plain    |              | zlib             | 2                 | 65536      | 
 b      | double precision |           | plain    |              | zlib             | 2                 | 32768      | 
 c      | integer          |           | plain    |              | rle_type         | 2                 | 32768      | 
 d      | text             |           | extended |              | zlib             | 2                 | 32768      | 
Checksum: t
Distributed by: (a)
Options: orientation=column, appendonly=true, compresslevel=2

insert into t2 select i, 71/i, 2*i, 'abc'||2*i from generate_series(1,5)i;
select * from t2 order by 1;
 a | b  | c  |   d   
---+----+----+-------
 1 | 71 |  2 | abc2
 2 | 35 |  4 | abc4
 3 | 23 |  6 | abc6
 4 | 17 |  8 | abc8
 5 | 14 | 10 | abc10
(5 rows)

select attrelid::regclass, attnum, attoptions
	from pg_attribute_encoding order by 1,2;
 attrelid | attnum |                       attoptions                        
----------+--------+---------------------------------------------------------
 t2       |      1 | {blocksize=65536,compresstype=zlib,compresslevel=2}
 t2       |      2 | {compresstype=zlib,compresslevel=2,blocksize=32768}
 t2       |      3 | {compresstype=rle_type,compresslevel=2,blocksize=32768}
 t2       |      4 | {compresstype=zlib,blocksize=32768,compresslevel=2}
(4 rows)

-- SET operation in a session has higher precedence.  Also test if
-- compresstype is correctly inferred based on compress level.
set gp_default_storage_options=
	"appendonly=true,compresslevel=4,checksum=false";
show gp_default_storage_options;
                                    gp_default_storage_options                                    
--------------------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=zlib,compresslevel=4,checksum=false,orientation=row
(1 row)

create table t3 (a int, b int, c text) distributed by (a);
insert into t3 select i, i, 'abc' from generate_series(1,5)i;
select * from t3 order by 1;
 a | b |  c  
---+---+-----
 1 | 1 | abc
 2 | 2 | abc
 3 | 3 | abc
 4 | 4 | abc
 5 | 5 | abc
(5 rows)

select relname,relstorage,relkind,reloptions from pg_class
	where relname in ('t1', 't2', 't3') order by 1;
 relname | relstorage | relkind |                      reloptions                      
---------+------------+---------+------------------------------------------------------
 t1      | a          | r       | {appendonly=true,compresslevel=2}
 t2      | c          | r       | {orientation=column,appendonly=true,compresslevel=2}
 t3      | a          | r       | {appendonly=true,compresslevel=4,checksum=false}
(3 rows)

select relid::regclass, blocksize, compresstype,
	compresslevel, columnstore, checksum from pg_appendonly order by 1;
 relid | blocksize | compresstype | compresslevel | columnstore | checksum 
-------+-----------+--------------+---------------+-------------+----------
 t1    |     32768 | zlib         |             2 | f           | t
 t2    |     32768 | zlib         |             2 | t           | t
 t3    |     32768 | zlib         |             4 | f           | f
(3 rows)

-- The GUC has checksum=false. Test that you can still turn it in WITH, and
-- that it affects partitions and subpartitions, too.
Create table alter_part_tab1 (id SERIAL,a1 int ,a2 char(5) ,a3 text )
WITH (appendonly=true, orientation=column, checksum=true,compresstype=zlib)
partition by list(a2) subpartition by range(a1)
subpartition template
  (default subpartition subothers,
   subpartition sp1 start(1) end(9) with (appendonly=true,orientation=column,checksum=true,compresstype=rle_type),
   subpartition sp2 start(11) end(20) with(appendonly=true,orientation=column,checksum=true,compresstype=none))
(partition p1 values('val1'),
 partition p2 values('val2'));
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'id' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p1" for table "alter_part_tab1"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p1_2_prt_subothers" for table "alter_part_tab1_1_prt_p1"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p1_2_prt_sp1" for table "alter_part_tab1_1_prt_p1"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p1_2_prt_sp2" for table "alter_part_tab1_1_prt_p1"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p2" for table "alter_part_tab1"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p2_2_prt_subothers" for table "alter_part_tab1_1_prt_p2"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p2_2_prt_sp1" for table "alter_part_tab1_1_prt_p2"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p2_2_prt_sp2" for table "alter_part_tab1_1_prt_p2"
Insert into alter_part_tab1(a1,a2,a3)
  select g, 'val1', 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.' from generate_series(1,10) g;
Insert into alter_part_tab1(a1,a2,a3)
  select g, 'val1', 'Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.' from generate_series(11, 20) g;
select count(*) from alter_part_tab1;
 count 
-------
    20
(1 row)

-- Make sure that adding a column doesn't affect checksums.
alter table alter_part_tab1 add column a4 numeric default 5.5;
-- Check that it works for ADD PARTITION, too.
ALTER TABLE alter_part_tab1 ADD partition p31 values(1) WITH (appendonly=true, orientation=column, checksum=true,compresstype=zlib);
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p31" for table "alter_part_tab1"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p31_2_prt_subothers" for table "alter_part_tab1_1_prt_p31"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p31_2_prt_sp1" for table "alter_part_tab1_1_prt_p31"
NOTICE:  CREATE TABLE will create partition "alter_part_tab1_1_prt_p31_2_prt_sp2" for table "alter_part_tab1_1_prt_p31"
SELECT relname, checksum from pg_appendonly ao, pg_class c where ao.relid = c.oid and relname like 'alter_part_tab1%';
                  relname                  | checksum 
-------------------------------------------+----------
 alter_part_tab1_1_prt_p1_2_prt_sp1        | t
 alter_part_tab1_1_prt_p1_2_prt_sp2        | t
 alter_part_tab1_1_prt_p1                  | t
 alter_part_tab1_1_prt_p31_2_prt_sp1       | t
 alter_part_tab1_1_prt_p2_2_prt_subothers  | t
 alter_part_tab1_1_prt_p2_2_prt_sp1        | t
 alter_part_tab1_1_prt_p2_2_prt_sp2        | t
 alter_part_tab1_1_prt_p2                  | t
 alter_part_tab1                           | t
 alter_part_tab1_1_prt_p1_2_prt_subothers  | t
 alter_part_tab1_1_prt_p31                 | t
 alter_part_tab1_1_prt_p31_2_prt_subothers | t
 alter_part_tab1_1_prt_p31_2_prt_sp2       | t
(13 rows)

drop table alter_part_tab1;
-- attribute encoding tests for column oriented tables
set gp_default_storage_options=
	"appendonly=true,orientation=column,compresslevel=1";
show gp_default_storage_options;
                                     gp_default_storage_options                                     
----------------------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=zlib,compresslevel=1,checksum=true,orientation=column
(1 row)

create table co1 (a int, b int) distributed by (a);
create table co2 (a int, b int) with (blocksize=8192)
	distributed by (a);
create table co3 (
	a int encoding(blocksize=65536),
	b float encoding(compresstype=zlib,compresslevel=6),
	c char encoding(compresstype=rle_type))
	distributed by(a);
create table co4 (a int, b int, c varchar,
	default column encoding (compresslevel=5))
	distributed by (a);
create table co5 (a int, b int, c varchar encoding(compresslevel=0),
	default column encoding (compresslevel=5))
	distributed by (a);
create table co6(a char, b bytea, c float, d int,
	default column encoding (compresstype=RLE_TYPE))
	with (checksum=true) distributed by (a);
create table co7(
	a int encoding(blocksize=8192,compresstype=none),
	b varchar encoding(compresstype=zlib,compresslevel=6),
	c char encoding(compresstype=rle_type))
	with (checksum=false) distributed by (a);
select relid::regclass,compresslevel,compresstype,blocksize,checksum,columnstore
	from pg_appendonly order by 1;
 relid | compresslevel | compresstype | blocksize | checksum | columnstore 
-------+---------------+--------------+-----------+----------+-------------
 t1    |             2 | zlib         |     32768 | t        | f
 t2    |             2 | zlib         |     32768 | t        | t
 t3    |             4 | zlib         |     32768 | f        | f
 co1   |             1 | zlib         |     32768 | t        | t
 co2   |             1 | zlib         |      8192 | t        | t
 co3   |             1 | zlib         |     32768 | t        | t
 co4   |             1 | zlib         |     32768 | t        | t
 co5   |             1 | zlib         |     32768 | t        | t
 co6   |             1 | zlib         |     32768 | t        | t
 co7   |             1 | zlib         |     32768 | f        | t
(10 rows)

select attrelid::regclass,attnum,attoptions
	from pg_attribute_encoding order by 1,2;
 attrelid | attnum |                       attoptions                        
----------+--------+---------------------------------------------------------
 t2       |      1 | {blocksize=65536,compresstype=zlib,compresslevel=2}
 t2       |      2 | {compresstype=zlib,compresslevel=2,blocksize=32768}
 t2       |      3 | {compresstype=rle_type,compresslevel=2,blocksize=32768}
 t2       |      4 | {compresstype=zlib,blocksize=32768,compresslevel=2}
 co1      |      1 | {compresstype=zlib,blocksize=32768,compresslevel=1}
 co1      |      2 | {compresstype=zlib,blocksize=32768,compresslevel=1}
 co2      |      1 | {blocksize=8192,compresstype=zlib,compresslevel=1}
 co2      |      2 | {blocksize=8192,compresstype=zlib,compresslevel=1}
 co3      |      1 | {blocksize=65536,compresstype=zlib,compresslevel=1}
 co3      |      2 | {compresstype=zlib,compresslevel=6,blocksize=32768}
 co3      |      3 | {compresstype=rle_type,compresslevel=1,blocksize=32768}
 co4      |      1 | {compresslevel=5,compresstype=zlib,blocksize=32768}
 co4      |      2 | {compresslevel=5,compresstype=zlib,blocksize=32768}
 co4      |      3 | {compresslevel=5,compresstype=zlib,blocksize=32768}
 co5      |      1 | {compresslevel=5,compresstype=zlib,blocksize=32768}
 co5      |      2 | {compresslevel=5,compresstype=zlib,blocksize=32768}
 co5      |      3 | {compresslevel=0,compresstype=none,blocksize=32768}
 co6      |      1 | {compresstype=rle_type,compresslevel=1,blocksize=32768}
 co6      |      2 | {compresstype=rle_type,compresslevel=1,blocksize=32768}
 co6      |      3 | {compresstype=rle_type,compresslevel=1,blocksize=32768}
 co6      |      4 | {compresstype=rle_type,compresslevel=1,blocksize=32768}
 co7      |      1 | {blocksize=8192,compresstype=none,compresslevel=0}
 co7      |      2 | {compresstype=zlib,compresslevel=6,blocksize=32768}
 co7      |      3 | {compresstype=rle_type,compresslevel=1,blocksize=32768}
(24 rows)

drop database if exists dsp3;
create database dsp3;
\c dsp3
set gp_default_storage_options=
	"appendonly=true,orientation=column,compresslevel=0";
show gp_default_storage_options;
                             gp_default_storage_options                             
------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=none,checksum=true,orientation=column
(1 row)

create table co1(
	a int encoding (compresstype=rle_type),
	b float encoding (compresslevel=5),
	c char encoding (compresslevel=0,blocksize=65536),
	d float) distributed by (a);
set gp_default_storage_options=
	"appendonly=true,orientation=column,compresslevel=3";
show gp_default_storage_options;
                                     gp_default_storage_options                                     
----------------------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=zlib,compresslevel=3,checksum=true,orientation=column
(1 row)

create table co2(
	a int encoding (compresstype=rle_type),
	b float encoding (compresslevel=5),
	c char encoding (compresslevel=0,blocksize=65536),
	d float,
	default column encoding (compresstype=none))
	distributed by (a);
-- attribute encoding should be set correctly.
set gp_default_storage_options='appendonly=false, orientation=column';
show gp_default_storage_options;
                             gp_default_storage_options                              
-------------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=none,checksum=true,orientation=column
(1 row)

create table co3 (a int, b float) with (appendonly=true) distributed by (a);
create table co4 (a int encoding (blocksize=8192), b int) distributed by (a);
ERROR:  ENCODING clause only supported with column oriented tables
set gp_default_storage_options='appendonly=true';
create table co5 (a int encoding (blocksize=8192), b float)
	with (orientation=column, checksum=false) distributed by (a);
select relid::regclass,compresslevel,compresstype,blocksize,checksum,columnstore
	from pg_appendonly order by 1;
 relid | compresslevel | compresstype | blocksize | checksum | columnstore 
-------+---------------+--------------+-----------+----------+-------------
 co1   |             0 |              |     32768 | t        | t
 co2   |             3 | zlib         |     32768 | t        | t
 co3   |             0 |              |     32768 | t        | t
 co5   |             0 |              |     32768 | f        | t
(4 rows)

select attrelid::regclass,attnum,attoptions
	from pg_attribute_encoding order by 1,2;
 attrelid | attnum |                       attoptions                        
----------+--------+---------------------------------------------------------
 co1      |      1 | {compresstype=rle_type,compresslevel=1,blocksize=32768}
 co1      |      2 | {compresslevel=5,compresstype=zlib,blocksize=32768}
 co1      |      3 | {compresslevel=0,blocksize=65536,compresstype=none}
 co1      |      4 | {compresstype=none,blocksize=32768,compresslevel=0}
 co2      |      1 | {compresstype=rle_type,compresslevel=3,blocksize=32768}
 co2      |      2 | {compresslevel=5,compresstype=zlib,blocksize=32768}
 co2      |      3 | {compresslevel=0,blocksize=65536,compresstype=none}
 co2      |      4 | {compresstype=none,compresslevel=0,blocksize=32768}
 co3      |      1 | {compresstype=none,blocksize=32768,compresslevel=0}
 co3      |      2 | {compresstype=none,blocksize=32768,compresslevel=0}
 co5      |      1 | {blocksize=8192,compresstype=none,compresslevel=0}
 co5      |      2 | {compresstype=none,blocksize=32768,compresslevel=0}
(12 rows)

-- misc tests
alter database dsp1 set gp_default_storage_options="appendonly=false";
\c dsp1
show gp_default_storage_options;
                            gp_default_storage_options                            
----------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=none,checksum=true,orientation=row
(1 row)

\c dsp3
alter database dsp1 set gp_default_storage_options=
	"appendonly=true, compresstype=zlib";
\c dsp1
show gp_default_storage_options;
                                   gp_default_storage_options                                    
-------------------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=zlib,compresslevel=1,checksum=true,orientation=row
(1 row)

-- options without "appendonly"
set gp_default_storage_options='compresstype=rle_type, orientation = column';
show gp_default_storage_options;
                                       gp_default_storage_options                                        
---------------------------------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=rle_type,compresslevel=1,checksum=true,orientation=column
(1 row)

set gp_default_storage_options='compresslevel=0,orientation=column';
show gp_default_storage_options;
                             gp_default_storage_options                              
-------------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=none,checksum=true,orientation=column
(1 row)

set gp_default_storage_options=
	'appendonly=false, checksum=false, orientation=column';
show gp_default_storage_options;
                              gp_default_storage_options                              
--------------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=none,checksum=false,orientation=column
(1 row)

\c dsp3
set gp_default_storage_options=
	"appendonly=true,orientation=column,compresslevel=5";
show gp_default_storage_options;
                                     gp_default_storage_options                                     
----------------------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=zlib,compresslevel=5,checksum=true,orientation=column
(1 row)

-- negative tests - should fail due to invalid combinations of
-- compresslevel and compresstype.
create table co6(
	a int encoding (compresstype=rle_type),
	b float encoding (blocksize=8192))
	distributed by (a);
ERROR:  compresslevel=5 is out of range for rle_type (should be in the range 1 to 4)
create table co7(a int, b float,
	default column encoding (compresstype=RLE_TYPE, compresslevel=7))
	distributed by (a);
ERROR:  compresslevel=7 is out of range for rle_type (should be in the range 1 to 4)
-- negative tests - session level set
set gp_default_storage_options="compresstype=zlib,compresslevel=11";
ERROR:  compresslevel=11 is out of range for zlib (should be in the range 1 to 9)
set gp_default_storage_options="compresslevel=5,compresstype=RLE_TYPE";
ERROR:  compresslevel=5 is out of range for rle_type (should be in the range 1 to 4)
set gp_default_storage_options="compresslevel=1,compresstype=rle";
ERROR:  unknown compresstype "rle"
set gp_default_storage_options="checksum=1234";
ERROR:  invalid bool value "1234" for storage option "checksum"
set gp_default_storage_options="blocksize=true";
ERROR:  invalid integer value "true" for storage option "blocksize"
set gp_default_storage_options="compresstype = rle_type";
ERROR:  rle_type cannot be used with Append Only relations row orientation
set gp_default_storage_options='blocksize=8192,checksumblah=true';
ERROR:  invalid storage option "checksumblah"
set gp_default_storage_options='orientation=columnblah';
ERROR:  invalid value "columnblah" for storage option "orientation"
show gp_default_storage_options;
                                     gp_default_storage_options                                     
----------------------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=zlib,compresslevel=5,checksum=true,orientation=column
(1 row)

-- negative tests - database level
alter database dsp1 set gp_default_storage_options="compresslevel=-12";
ERROR:  invalid value for option "compresslevel"
alter database dsp1 set
	gp_default_storage_options="appendonly=false,checksum=invalid";
ERROR:  invalid bool value "invalid" for storage option "checksum"
alter database dsp1 set	gp_default_storage_options=
	"compresstype=zlib,compresslevel=0";
ERROR:  compresstype "zlib" can't be used with compresslevel 0
-- set_config() tests
select pg_catalog.set_config('gp_default_storage_options',
    'appendonly=true, orientation=column', false);
                                     set_config                                     
------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=none,checksum=true,orientation=column
(1 row)

show gp_default_storage_options;
                             gp_default_storage_options                             
------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=none,checksum=true,orientation=column
(1 row)

create table co8 (a int, b float) distributed by (a);
\d+ co8
                                             Append-Only Columnar Table "public.co8"
 Column |       Type       | Modifiers | Storage | Stats target | Compression Type | Compression Level | Block Size | Description 
--------+------------------+-----------+---------+--------------+------------------+-------------------+------------+-------------
 a      | integer          |           | plain   |              | none             | 0                 | 32768      | 
 b      | double precision |           | plain   |              | none             | 0                 | 32768      | 
Checksum: t
Distributed by: (a)
Options: appendonly=true, orientation=column

-- ensure that set_config() has propagated to segments by insert and
-- select into a column oriented table.
insert into co8 select i, i/2 from generate_series(1,10)i;
select count(b) from co8;
 count 
-------
    10
(1 row)

begin;
select pg_catalog.set_config('gp_default_storage_options',
    'compresslevel=2', true);
                                            set_config                                            
--------------------------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=zlib,compresslevel=2,checksum=true,orientation=row
(1 row)

show gp_default_storage_options;
                                    gp_default_storage_options                                    
--------------------------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=zlib,compresslevel=2,checksum=true,orientation=row
(1 row)

create table ao1 (a int, b int) with (appendonly=true) distributed by (a);
\d+ ao1;
                   Append-Only Table "public.ao1"
 Column |  Type   | Modifiers | Storage | Stats target | Description 
--------+---------+-----------+---------+--------------+-------------
 a      | integer |           | plain   |              | 
 b      | integer |           | plain   |              | 
Compression Type: zlib
Compression Level: 2
Block Size: 32768
Checksum: t
Distributed by: (a)
Options: appendonly=true, compresslevel=2

insert into ao1 select i, i from generate_series(1,100)i;
select count(*) from ao1;
 count 
-------
   100
(1 row)

end;
-- GUC should be reset after end of transaction.
show gp_default_storage_options;
                             gp_default_storage_options                             
------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=none,checksum=true,orientation=column
(1 row)

-- verify reset happendon on segments by create, insert, select.
create table co9 (x int, y float) distributed by (x);
\d+ co9
                                             Append-Only Columnar Table "public.co9"
 Column |       Type       | Modifiers | Storage | Stats target | Compression Type | Compression Level | Block Size | Description 
--------+------------------+-----------+---------+--------------+------------------+-------------------+------------+-------------
 x      | integer          |           | plain   |              | none             | 0                 | 32768      | 
 y      | double precision |           | plain   |              | none             | 0                 | 32768      | 
Checksum: t
Distributed by: (x)
Options: appendonly=true, orientation=column

-- ensure that set_config() has propagated to segments by insert and
-- select into a column oriented table.
insert into co9 select i, i/2 from generate_series(1,10)i;
select count(y) from co9;
 count 
-------
    10
(1 row)

set gp_default_storage_options='compresstype=none';
show gp_default_storage_options;
                            gp_default_storage_options                            
----------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=none,checksum=true,orientation=row
(1 row)

-- compresstype should be correctly inferred.
create table ao2 (a int, b int) with
    (appendonly=true, compresslevel=4) distributed by (a);
\d ao2
Append-Only Table "public.ao2"
 Column |  Type   | Modifiers 
--------+---------+-----------
 a      | integer | 
 b      | integer | 
Compression Type: zlib
Compression Level: 4
Block Size: 32768
Checksum: t
Distributed by: (a)

-- MPP-25073 verify if compresstype=none is represented as NULL.
set gp_default_storage_options='';
create table ao4 (a int, b int) with (appendonly=true)
    distributed by (a);
\d ao4
Append-Only Table "public.ao4"
 Column |  Type   | Modifiers 
--------+---------+-----------
 a      | integer | 
 b      | integer | 
Compression Type: None
Compression Level: 0
Block Size: 32768
Checksum: t
Distributed by: (a)

select reloptions from pg_class where relname = 'ao4';
    reloptions     
-------------------
 {appendonly=true}
(1 row)

select compresstype from pg_appendonly where relid = 'ao4'::regclass;
 compresstype 
--------------
 
(1 row)

set gp_default_storage_options='appendonly=true,compresstype=NONE';
create table co10 (a int, b int, c int) with (orientation=column)
    distributed by (a);
select attnum,attoptions from pg_attribute_encoding
    where attrelid = 'co10'::regclass order by attnum;
 attnum |                     attoptions                      
--------+-----------------------------------------------------
      1 | {compresstype=none,blocksize=32768,compresslevel=0}
      2 | {compresstype=none,blocksize=32768,compresslevel=0}
      3 | {compresstype=none,blocksize=32768,compresslevel=0}
(3 rows)

select compresstype from pg_appendonly where relid = 'co10'::regclass;
 compresstype 
--------------
 
(1 row)

-- compression disabled by default, enable in WITH clause
set gp_default_storage_options = 'appendonly=true';
show gp_default_storage_options;
                           gp_default_storage_options                            
---------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=none,checksum=true,orientation=row
(1 row)

-- compresstype only
create table ao5 (a int, b int) with (compresstype=zlib)
    distributed by (a);
\d ao5
Append-Only Table "public.ao5"
 Column |  Type   | Modifiers 
--------+---------+-----------
 a      | integer | 
 b      | integer | 
Compression Type: zlib
Compression Level: 1
Block Size: 32768
Checksum: t
Distributed by: (a)

insert into ao5 select i, i from generate_series(1,10)i;
-- compresslevel only
create table ao6 with (compresslevel=4) as select * from ao5
    distributed by (a);
\d ao6
Append-Only Table "public.ao6"
 Column |  Type   | Modifiers 
--------+---------+-----------
 a      | integer | 
 b      | integer | 
Compression Type: zlib
Compression Level: 4
Block Size: 32768
Checksum: t
Distributed by: (a)

-- both compresstype and compresslevel
create table ao7 with (compresstype=zlib, compresslevel=3) as
    select * from ao6 distributed by (a);
\d ao7
Append-Only Table "public.ao7"
 Column |  Type   | Modifiers 
--------+---------+-----------
 a      | integer | 
 b      | integer | 
Compression Type: zlib
Compression Level: 3
Block Size: 32768
Checksum: t
Distributed by: (a)

-- compression enabled by default, disable in WITH clause
set gp_default_storage_options = 'appendonly=true, compresstype=zlib';
show gp_default_storage_options;
                                   gp_default_storage_options                                    
-------------------------------------------------------------------------------------------------
 appendonly=true,blocksize=32768,compresstype=zlib,compresslevel=1,checksum=true,orientation=row
(1 row)

-- compresstype only
create table ao8 with (compresstype=none) as select * from ao7
    distributed by (a);
\d ao8
Append-Only Table "public.ao8"
 Column |  Type   | Modifiers 
--------+---------+-----------
 a      | integer | 
 b      | integer | 
Compression Type: none
Compression Level: 1
Block Size: 32768
Checksum: t
Distributed by: (a)

-- compresslevel only (should fail)
create table ao9 with (compresslevel=0) as select * from ao8
    distributed by (a);
ERROR:  compresstype "zlib" can't be used with compresslevel 0
create table ao10 with (compresslevel=0, compresstype=none)
    as select * from ao8 distributed by (a);
-- MPP-14504: we need to allow compresstype=none with compresslevel>0
create table ao11 (a int, b int) with (compresstype=none, compresslevel=2)
    distributed by (a);
\d ao11
Append-Only Table "public.ao11"
 Column |  Type   | Modifiers 
--------+---------+-----------
 a      | integer | 
 b      | integer | 
Compression Type: none
Compression Level: 2
Block Size: 32768
Checksum: t
Distributed by: (a)

set gp_default_storage_options='compresstype=none,compresslevel=2';
show gp_default_storage_options;
                                    gp_default_storage_options                                    
--------------------------------------------------------------------------------------------------
 appendonly=false,blocksize=32768,compresstype=none,compresslevel=2,checksum=true,orientation=row
(1 row)

create table ao12 (a int, b int) with (appendonly=true) distributed by (a);
\d ao12
Append-Only Table "public.ao12"
 Column |  Type   | Modifiers 
--------+---------+-----------
 a      | integer | 
 b      | integer | 
Compression Type: None
Compression Level: 2
Block Size: 32768
Checksum: t
Distributed by: (a)

--bitmap index
set gp_default_storage_options='appendonly=true';
create table bitmap_table(a int, b int, c varchar);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
create index bitmap_i on bitmap_table using bitmap(b);
-- external tables: ensure that default storage options are ignored
-- during external table creation.
set gp_default_storage_options='appendonly=true';
create external table ext_t1 (a int, b int)
    location ('file:///tmp/test.txt') format 'text';
\d+ ext_t1
                   External table "public.ext_t1"
 Column |  Type   | Modifiers | Storage | Stats target | Description 
--------+---------+-----------+---------+--------------+-------------
 a      | integer |           | plain   |              | 
 b      | integer |           | plain   |              | 
Type: readable
Encoding: UTF8
Format type: text
Format options: delimiter '	' null '\N' escape '\'
External options: {}
External location: file:///tmp/test.txt
Execute on: all segments

create external table ext_error_logging_off (a int, b int)
    location ('file:///tmp/test.txt') format 'text'
    segment reject limit 100;
\d+ ext_error_logging_off
            External table "public.ext_error_logging_off"
 Column |  Type   | Modifiers | Storage | Stats target | Description 
--------+---------+-----------+---------+--------------+-------------
 a      | integer |           | plain   |              | 
 b      | integer |           | plain   |              | 
Type: readable
Encoding: UTF8
Format type: text
Format options: delimiter '	' null '\N' escape '\'
External options: {}
External location: file:///tmp/test.txt
Execute on: all segments
Segment reject limit: 100 rows

create external table ext_t2 (a int, b int)
    location ('file:///tmp/test.txt') format 'text'
    log errors segment reject limit 100;
\d+ ext_t2
                   External table "public.ext_t2"
 Column |  Type   | Modifiers | Storage | Stats target | Description 
--------+---------+-----------+---------+--------------+-------------
 a      | integer |           | plain   |              | 
 b      | integer |           | plain   |              | 
Type: readable
Encoding: UTF8
Format type: text
Format options: delimiter '	' null '\N' escape '\'
External options: {}
External location: file:///tmp/test.txt
Execute on: all segments
Segment reject limit: 100 rows
Error Log in File

-- Make sure gp_default_storage_options GUC value is set in newly created cdbgangs
-- after previous idle cdbgang is stopped
SET gp_vmem_idle_resource_timeout=30;
SET gp_default_storage_options='appendonly=true,blocksize=32768,compresstype=none,checksum=true,orientation=row';
\! sleep 1
CREATE TABLE check_guc_value_after_new_cdbgang (a int) DISTRIBUTED RANDOMLY;
SELECT DISTINCT relid::regclass FROM pg_appendonly WHERE relid='check_guc_value_after_new_cdbgang'::regclass;
               relid               
-----------------------------------
 check_guc_value_after_new_cdbgang
(1 row)

SELECT DISTINCT relid::regclass FROM gp_dist_random('pg_appendonly') WHERE relid='check_guc_value_after_new_cdbgang'::regclass;
               relid               
-----------------------------------
 check_guc_value_after_new_cdbgang
(1 row)

SELECT DISTINCT relname, reloptions FROM pg_class WHERE relname='check_guc_value_after_new_cdbgang';
              relname              |    reloptions     
-----------------------------------+-------------------
 check_guc_value_after_new_cdbgang | {appendonly=true}
(1 row)

SELECT DISTINCT relname, reloptions FROM gp_dist_random('pg_class') WHERE relname='check_guc_value_after_new_cdbgang';
              relname              |    reloptions     
-----------------------------------+-------------------
 check_guc_value_after_new_cdbgang | {appendonly=true}
(1 row)

RESET gp_vmem_idle_resource_timeout;
-- Make sure ALTER TABLE REORGANIZE does not change the table type due
-- to gp_default_storage_options GUC
set gp_default_storage_options='appendonly=false,blocksize=32768';
create table alter_table_reorg_heap (a int, b text);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
select relname, relstorage, reloptions from pg_class where relname='alter_table_reorg_heap';
        relname         | relstorage | reloptions 
------------------------+------------+------------
 alter_table_reorg_heap | h          | 
(1 row)

set gp_default_storage_options='appendonly=true,blocksize=32768,orientation=column';
alter table alter_table_reorg_heap set with (reorganize=true);
select relname, relstorage, reloptions from pg_class where relname='alter_table_reorg_heap';
        relname         | relstorage | reloptions 
------------------------+------------+------------
 alter_table_reorg_heap | h          | 
(1 row)

set gp_default_storage_options='appendonly=true,blocksize=32768,orientation=column';
create table alter_table_reorg_aoco (a int, b text);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
select relname, relstorage, reloptions from pg_class where relname='alter_table_reorg_aoco';
        relname         | relstorage |              reloptions              
------------------------+------------+--------------------------------------
 alter_table_reorg_aoco | c          | {appendonly=true,orientation=column}
(1 row)

set gp_default_storage_options='appendonly=false,blocksize=32768';
alter table alter_table_reorg_aoco set with (reorganize=true);
select relname, relstorage, reloptions from pg_class where relname='alter_table_reorg_aoco';
        relname         | relstorage |              reloptions              
------------------------+------------+--------------------------------------
 alter_table_reorg_aoco | c          | {appendonly=true,orientation=column}
(1 row)

-- Make sure SELECT INTO uses gp_default_storage_options GUC
create table select_into_heap_from (a int, b text);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
insert into select_into_heap_from select i, 'aaa' from generate_series(1,50)i;
set gp_default_storage_options='appendonly=true,blocksize=32768,orientation=column';
select * into select_into_heap_to from select_into_heap_from;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
select relname, relstorage, reloptions from pg_class where relname='select_into_heap_to';
       relname       | relstorage |              reloptions              
---------------------+------------+--------------------------------------
 select_into_heap_to | c          | {appendonly=true,orientation=column}
(1 row)

select count(*) from select_into_heap_to;
 count 
-------
    50
(1 row)

-- Also check CTAS works fine
create table ctas_ao_from_heap as select * from select_into_heap_from;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
select relname, relstorage, reloptions from pg_class where relname='ctas_ao_from_heap';
      relname      | relstorage |              reloptions              
-------------------+------------+--------------------------------------
 ctas_ao_from_heap | c          | {appendonly=true,orientation=column}
(1 row)

select count(*) from ctas_ao_from_heap;
 count 
-------
    50
(1 row)

RESET gp_default_storage_options;
create table dsp_partition1(i int, j int, k int) with(appendonly=true) partition by range(i) (start(1) end(10) every(5));
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'i' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
NOTICE:  CREATE TABLE will create partition "dsp_partition1_1_prt_1" for table "dsp_partition1"
NOTICE:  CREATE TABLE will create partition "dsp_partition1_1_prt_2" for table "dsp_partition1"
Insert into dsp_partition1 select i, i+1, i+2 from generate_series(1,9) i;
select count(*) from dsp_partition1;
 count 
-------
     9
(1 row)

select relname, relkind, relstorage, reloptions from pg_class where relname like 'dsp_partition1%' order by relname;
        relname         | relkind | relstorage |    reloptions     
------------------------+---------+------------+-------------------
 dsp_partition1         | r       | a          | {appendonly=true}
 dsp_partition1_1_prt_1 | r       | a          | {appendonly=true}
 dsp_partition1_1_prt_2 | r       | a          | {appendonly=true}
(3 rows)

select compresslevel, compresstype, blocksize, checksum, columnstore from pg_appendonly
       where relid in (select oid from pg_class where relname  like 'dsp_partition1%') order by columnstore;
 compresslevel | compresstype | blocksize | checksum | columnstore 
---------------+--------------+-----------+----------+-------------
             0 |              |     32768 | t        | f
             0 |              |     32768 | t        | f
             0 |              |     32768 | t        | f
(3 rows)

set gp_default_storage_options="appendonly=true, orientation=column";
-- Add partition
alter table dsp_partition1 add partition p3 start(11) end(15);
NOTICE:  CREATE TABLE will create partition "dsp_partition1_1_prt_p3" for table "dsp_partition1"
alter table dsp_partition1 add partition p4 start(16) end(18) with(appendonly=false);
NOTICE:  CREATE TABLE will create partition "dsp_partition1_1_prt_p4" for table "dsp_partition1"
select relname, relkind, relstorage, reloptions from pg_class where relname like 'dsp_partition1%' order by relname;
         relname         | relkind | relstorage |              reloptions              
-------------------------+---------+------------+--------------------------------------
 dsp_partition1          | r       | a          | {appendonly=true}
 dsp_partition1_1_prt_1  | r       | a          | {appendonly=true}
 dsp_partition1_1_prt_2  | r       | a          | {appendonly=true}
 dsp_partition1_1_prt_p3 | r       | c          | {appendonly=true,orientation=column}
 dsp_partition1_1_prt_p4 | r       | h          | {appendonly=false}
(5 rows)

-- Split partition
alter table dsp_partition1 split partition for (rank(2)) at (7) into (partition split_p1, partition split_p2);
NOTICE:  CREATE TABLE will create partition "dsp_partition1_1_prt_split_p1" for table "dsp_partition1"
NOTICE:  CREATE TABLE will create partition "dsp_partition1_1_prt_split_p2" for table "dsp_partition1"
select relname, relkind, relstorage, reloptions from pg_class where relname like 'dsp_partition1%' order by relname;
            relname            | relkind | relstorage |              reloptions              
-------------------------------+---------+------------+--------------------------------------
 dsp_partition1                | r       | a          | {appendonly=true}
 dsp_partition1_1_prt_1        | r       | a          | {appendonly=true}
 dsp_partition1_1_prt_p3       | r       | c          | {appendonly=true,orientation=column}
 dsp_partition1_1_prt_p4       | r       | h          | {appendonly=false}
 dsp_partition1_1_prt_split_p1 | r       | c          | {appendonly=true,orientation=column}
 dsp_partition1_1_prt_split_p2 | r       | c          | {appendonly=true,orientation=column}
(6 rows)

RESET gp_default_storage_options;
-- cleanup
\c postgres
-- start_matchsubs
-- m/.*\[ERROR\]*/
-- s/.*\[ERROR\]/[ERROR]/gm
-- end_matchsubs
\!gpconfig -c gp_default_storage_options -v 'appendonly=true' --masteronly
[ERROR]:-gp_default_storage_options value cannot be different on master and segments
gp_default_storage_options value cannot be different on master and segments
\!gpconfig -c gp_default_storage_options -v 'appendonly=true' -m 'appendonly=false'
[ERROR]:-gp_default_storage_options value cannot be different on master and segments
gp_default_storage_options value cannot be different on master and segments
\!gpconfig -s gp_default_storage_options
Values on all segments are consistent
GUC          : gp_default_storage_options
Master  value: appendonly=false,blocksize=32768,compresstype=none,checksum=true,orientation=row
Segment value: appendonly=false,blocksize=32768,compresstype=none,checksum=true,orientation=row
